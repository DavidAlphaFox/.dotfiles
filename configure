#!/bin/sh

SBCL=`which sbcl`
CURL=`which curl`
GIT=`which git`
ShellName=`echo "${SHELL}" | awk -F '/' '{print $NF}'`
System=`uname`

echo "It seems that you are using ${System} and ${ShellName}"

prompt_query () {
	while true; do
		echo "$1 [Y/N]?"
		read  yn
		case $yn in
			[Yy]* ) return 0;;
			[Nn]* ) return 1;;
			* ) echo "Please answer Y or N.";;
		esac
	done
}

is_exsist () {
	if [ ! -x "$1" ]; then
		return 1
	fi
	return 0
}

conf_delete () {
	for item in "$@"; do
		if [ -d "$HOME/${item}" ]; then
			if [ -L "$HOME/${item}" ]; then
       			echo "Delete link ${item}"
       			rm "$HOME/${item}"
			else
				echo "Delete directory ${item}"
	  			rm -rf "$HOME/${item}"
			fi
		else
			if [ -f "$HOME/${item}" ]; then
				echo "Delete link or file ${item}"
				rm "$HOME/${item}"	
			fi
		fi
	done
}

emacs_conf_files=".emacs .emacs.d"
quicklisp_conf_files=".sbclrc quicklisp"

if prompt_query "Enable Emacs"; then
	echo "Delete and link conf files for Emacs"
	conf_delete $emacs_conf_files
	ln -s .dotfiles/.emacs ../.emacs
	ln -s .dotfiles/.emacs.d ../.emacs.d
	if [ -d "$HOME/.emacs.d/tmp" ]; then
		echo "delete tmp of emacs"
		rm -rf "$HOME/.emacs.d/tmp"
	fi
	mkdir "$HOME/.emacs.d/tmp"

fi

if prompt_query "Setup quicklisp for sbcl"; then
	if is_exsist $SBCL is_exsist $CURL; then
		conf_delete $quicklisp_conf_files
		if [ -d "$HOME/.dotfiles/quicklisp" ]; then
			rm -rf "$HOME/.dotfiles/quicklisp/" 
		fi
		if [ -x "$HOME/.dotfiles/quicklisp.lisp" ]; then
			rm "$HOME/.dotfiles/quicklisp.lisp"
		fi
		curl -O "http://beta.quicklisp.org/quicklisp.lisp"
		sbcl --load ~/.dotfiles/pre_init.lisp
		mv ~/quicklisp ~/.dotfiles/
		ln -s .dotfiles/quicklisp ../quicklisp
		sbcl --load ~/.dotfiles/after_init.lisp
		ln -s .dotfiles/.sbclrc ../.sbclrc
		rm ~/.dotfiles/quicklisp.lisp
   else
		echo "I can't find ${CURL} or ${SBCL}"
   fi
fi


